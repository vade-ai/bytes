{:min-bb-version "1.0.0"

 :tasks
 {;; Development tasks
  dev
  {:doc "Start Clay in interactive browser watch mode"
   :task (shell "clojure -M:clay")}

  ;; Build tasks
  build
  {:doc "Build Clojure namespaces to Quarto markdown"
   :task (shell "clojure -M:clay -A:markdown")}

  render
  {:doc "Render Quarto site to HTML"
   :requires ([babashka.fs :as fs])
   :task (do
           (when-not (fs/exists? "site")
             (println "âŒ site/ directory not found")
             (System/exit 1))
           (shell "quarto render site")
           (println "âœ… Site rendered to site/_site/"))}

  site
  {:doc "Build and render complete site"
   :task (do
           (println "ğŸ“¦ Building content with Clay...")
           (run 'build)
           (println "\nğŸ¨ Rendering site with Quarto...")
           (run 'render))}

  ;; Preview tasks
  serve
  {:doc "Build and preview the site"
   :task (do
           (run 'site)
           (println "\nğŸŒ Starting preview server...")
           (shell "quarto preview site"))}

  watch
  {:doc "Watch .clj files and rebuild, with live preview"
   :requires ([babashka.fs :as fs]
              [babashka.process :as p])
   :task (do
           (println "ğŸ“¦ Initial build...")
           (run 'build)
           (println "\nğŸ‘€ Watching src/ for changes...")
           (println "ğŸŒ Starting Quarto preview (auto-refreshes on changes)...")
           (println "Press Ctrl+C to stop\n")

           ;; Start quarto preview in background
           (let [quarto-proc (p/process ["quarto" "preview" "site"] {:out :inherit :err :inherit})]

             ;; Watch for changes
             (fs/watch "src"
                       (fn [event]
                         (when (and (= (:type event) :modify)
                                    (clojure.string/ends-with? (str (:path event)) ".clj"))
                           (println (str "\nğŸ”„ Detected change: " (:path event)))
                           (println "ğŸ“¦ Rebuilding...")
                           (run 'build)
                           (println "âœ… Rebuild complete - Quarto will auto-refresh\n")))
                       {:recursive true})

             ;; Wait for quarto process
             (deref quarto-proc)))}

  ;; Clean tasks
  clean
  {:doc "Clean build artifacts"
   :requires ([babashka.fs :as fs])
   :task (do
           (when (fs/exists? "site/_site")
             (fs/delete-tree "site/_site")
             (println "ğŸ§¹ Removed site/_site/"))
           (when (fs/exists? "temp")
             (fs/delete-tree "temp")
             (println "ğŸ§¹ Removed temp/"))
           (when (fs/exists? ".quarto")
             (fs/delete-tree ".quarto")
             (println "ğŸ§¹ Removed .quarto/"))
           (doseq [qmd-dir (fs/glob "site" "**/*.qmd")]
             (let [parent (fs/parent qmd-dir)]
               (when (and (not= (str parent) "site")
                          (fs/exists? parent))
                 (fs/delete-tree parent)
                 (println (str "ğŸ§¹ Removed " parent)))))
           (println "âœ¨ Clean complete"))}

  clean-all
  {:doc "Deep clean including Clojure caches"
   :requires ([babashka.fs :as fs])
   :task (do
           (run 'clean)
           (when (fs/exists? ".cpcache")
             (fs/delete-tree ".cpcache")
             (println "ğŸ§¹ Removed .cpcache/")))}

  ;; Utility tasks
  check
  {:doc "Check if required tools are installed"
   :requires ([babashka.process :refer [shell]])
   :task (do
           (println "Checking required tools...")
           (try
             (shell {:out :string} "clojure --version")
             (println "âœ… Clojure CLI installed")
             (catch Exception _
               (println "âŒ Clojure CLI not found")))
           (try
             (shell {:out :string} "quarto --version")
             (println "âœ… Quarto installed")
             (catch Exception _
               (println "âŒ Quarto not found")))
           (try
             (shell {:out :string} "python3 --version")
             (println "âœ… Python installed")
             (catch Exception _
               (println "âŒ Python not found"))))}

  new-post
  {:doc "Create a new blog post from template"
   :requires ([babashka.fs :as fs]
              [clojure.string :as str])
   :task (let [title (or (first *command-line-args*)
                         (do (println "Usage: bb new-post <title>")
                             (System/exit 1)))
               slug (-> title
                        str/lower-case
                        (str/replace (re-pattern "\\s+") "_")
                        (str/replace (re-pattern "[^a-z0-9_]") ""))
               date (-> (java.time.LocalDate/now)
                        str)
               namespace-name (str "posts." slug)
               file-path (str "src/posts/" slug ".clj")]
           (when (fs/exists? file-path)
             (println (str "âŒ Post already exists: " file-path))
             (System/exit 1))
           (fs/create-dirs "src/posts")
           (spit file-path
                 (format "^{:kindly/hide-code true
  :clay {:title \"%s\"
         :quarto {:author \"Your Name\"
                  :date \"%s\"
                  :type :post
                  :category :clojure
                  :tags [:example]}}}
(ns %s
  (:require [scicloj.kindly.v4.kind :as kind]))

;; # %s
;;
;; Write your post content here...

;; ## Example

(+ 1 1)
"
                         title
                         date
                         namespace-name
                         title))
           (println (str "âœ… Created new post: " file-path)))}

  help
  {:doc "Show available tasks"
   :override-builtin true
   :task (do
           (println "Vade Bytes - Babashka Tasks\n")
           (println "Development:")
           (println "  bb dev        - Start Clay in interactive browser mode")
           (println "  bb watch      - Watch .clj files and auto-rebuild with live preview")
           (println "  bb serve      - Build and preview the static site")
           (println "\nBuilding:")
           (println "  bb build      - Build content with Clay")
           (println "  bb render     - Render site with Quarto")
           (println "  bb site       - Build and render (full build)")
           (println "\nMaintenance:")
           (println "  bb clean      - Remove build artifacts")
           (println "  bb clean-all  - Deep clean including caches")
           (println "  bb check      - Check required tools")
           (println "\nUtilities:")
           (println "  bb new-post <title> - Create a new blog post")
           (println "  bb help       - Show this help"))}}}
